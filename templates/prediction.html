{% extends "base.html" %}
{% block title %}Prédiction{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Prédiction d'obésité</h1>

<form id="predictForm" class="space-y-2">
  <label>Sexe</label>
  <select name="Gender" required class="border rounded p-1 w-full">
    <option value="Male">Male</option>
    <option value="Female">Female</option>
  </select>

  <label>Age</label>
  <input type="number" name="Age" step="0.1" required class="border rounded p-1 w-full">

  <label>Hauteur (m)</label>
  <input type="number" name="Height" step="0.01" required class="border rounded p-1 w-full">

  <label>Poids (kg)</label>
  <input type="number" name="Weight" step="0.1" required class="border rounded p-1 w-full">

  <label>Historique familial d'obésité</label>
  <select name="family_history_with_overweight" required class="border rounded p-1 w-full">
    <option value="Yes">Yes</option>
    <option value="No">No</option>
  </select>

  <label>FAVC</label>
  <select name="FAVC" required class="border rounded p-1 w-full">
    <option value="Yes">Yes</option>
    <option value="No">No</option>
  </select>

  <label>FCVC</label>
  <input type="number" name="FCVC" step="0.1" required class="border rounded p-1 w-full">

  <label>NCP</label>
  <input type="number" name="NCP" step="0.1" required class="border rounded p-1 w-full">

  <label>CAEC</label>
  <select name="CAEC" required class="border rounded p-1 w-full">
    <option value="Always">Always</option>
    <option value="Sometimes">Sometimes</option>
    <option value="Never">Never</option>
    <option value="Frequently">Frequently</option>
  </select>

  <label>SMOKE</label>
  <select name="SMOKE" required class="border rounded p-1 w-full">
    <option value="Yes">Yes</option>
    <option value="No">No</option>
  </select>

  <label>CH2O</label>
  <input type="number" name="CH2O" step="0.1" required class="border rounded p-1 w-full">

  <label>SCC</label>
  <select name="SCC" required class="border rounded p-1 w-full">
    <option value="Yes">Yes</option>
    <option value="No">No</option>
  </select>

  <label>FAF</label>
  <input type="number" name="FAF" step="0.1" required class="border rounded p-1 w-full">

  <label>TUE</label>
  <input type="number" name="TUE" step="0.1" required class="border rounded p-1 w-full">

  <label>CALC</label>
  <select name="CALC" required class="border rounded p-1 w-full">
    <option value="Yes">Yes</option>
    <option value="No">No</option>
  </select>

  <label>MTRANS</label>
  <select name="MTRANS" required class="border rounded p-1 w-full">
    <option value="Car">Car</option>
    <option value="Motorbike">Motorbike</option>
    <option value="Bike">Bike</option>
    <option value="Public_Transportation">Public_Transportation</option>
    <option value="Walking">Walking</option>
  </select>

  <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded mt-2">Prédire</button>
</form>

<div id="result" class="mt-4"></div>

<script>
const form = document.getElementById("predictForm");

form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const token = localStorage.getItem("access_token");
    if(!token){
        alert("Vous devez être connecté pour faire une prédiction.");
        window.location.href = "/auth/login";
        return;
    }

    // Récupérer les données du formulaire
    const formData = Object.fromEntries(new FormData(form).entries());

    // Convertir les champs numériques en nombres
    formData.Age = parseFloat(formData.Age);
    formData.Height = parseFloat(formData.Height);
    formData.Weight = parseFloat(formData.Weight);
    formData.FCVC = parseFloat(formData.FCVC);
    formData.NCP = parseFloat(formData.NCP);
    formData.CH2O = parseFloat(formData.CH2O);
    formData.FAF = parseFloat(formData.FAF);
    formData.TUE = parseFloat(formData.TUE);

    const res = await fetch("/predict/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
        },
        body: JSON.stringify(formData)
    });

    const resultDiv = document.getElementById("result");

    if(res.ok){
        const prediction = await res.json();
        let html = `<div class="p-4 bg-green-100 border border-green-400 rounded">
                        <strong>Classe prédite :</strong> ${prediction.predicted_class}<br>`;
        if(prediction.proba){
            html += "<strong>Probabilités :</strong><ul class='list-disc pl-5 mt-1'>";
            for(const [k,v] of Object.entries(prediction.proba)){
                html += `<li class="text-black">${k} : ${(v*100).toFixed(2)}%</li>`;
            }
            html += "</ul>";
        }
        html += "</div>";
        resultDiv.innerHTML = html;
    } else {
        const error = await res.json();
        resultDiv.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 rounded">${error.detail}</div>`;
    }
});
</script>
{% endblock %}
