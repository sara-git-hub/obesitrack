<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ObesiTrack{% endblock %}</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>

    <!-- Navbar dynamique -->
    <div class="navbar">
        <a href="/">Accueil</a>
        
        <!-- Menu par d√©faut (sera modifi√© par JS) -->
        <div id="nav-guest" class="nav-section">
            <a href="/auth/login">Connexion</a>
            <a href="/auth/register">Inscription</a>
        </div>
        
        <div id="nav-user" class="nav-section" style="display: none;">
            <a href="/predict">Nouvelle pr√©diction</a>
            <a href="/predict/history">Mes pr√©dictions</a>
            <span id="user-info" class="user-info"></span>
            <a href="#" onclick="logout()" class="logout-btn">D√©connexion</a>
        </div>
        
        <div id="nav-admin" class="nav-section" style="display: none;">
            <a href="/admin_web/dashboard">Dashboard</a>
            <a href="/admin_web/users">Gestion utilisateurs</a>
            <a href="/admin_web/predictions/recent">Toutes les pr√©dictions</a>
            <span id="admin-info" class="user-info"></span>
            <a href="#" onclick="logout()" class="logout-btn">D√©connexion</a>
        </div>
    </div>

    <!-- Conteneur principal -->
    <div class="container">
        {% block content %}
        {% endblock %}
    </div>

    <!-- Script pour g√©rer la navbar dynamique -->
    <script>
        // Fonction pour d√©coder le JWT (partie payload)
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                return null;
            }
        }

        // Fonction pour v√©rifier et afficher la navbar appropri√©e
        async function updateNavbar() {
            console.log('üîç Mise √† jour de la navbar...');
            const token = localStorage.getItem('access_token');
            console.log('üîë Token trouv√©:', token ? 'OUI' : 'NON');
            
            if (!token) {
                // Pas de token = utilisateur non connect√©
                console.log('üë§ Affichage navbar invit√©');
                showGuestNav();
                return;
            }

            // V√©rifier si le token est expir√©
            const payload = parseJwt(token);
            if (!payload || payload.exp < Date.now() / 1000) {
                // Token expir√©
                console.log('‚è∞ Token expir√©');
                localStorage.removeItem('access_token');
                showGuestNav();
                return;
            }
            console.log('‚úÖ Token valide, r√©cup√©ration des infos...');

            // Token valide, r√©cup√©rer les infos utilisateur
            try {
                const response = await fetch('/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    console.log('üë§ Utilisateur r√©cup√©r√©:', user);
                    showUserNav(user);
                } else {
                    // Token invalide c√¥t√© serveur
                    console.log('‚ùå Erreur serveur:', response.status);
                    localStorage.removeItem('access_token');
                    showGuestNav();
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de la r√©cup√©ration des infos utilisateur:', error);
                showGuestNav();
            }
        }

        function showGuestNav() {
            console.log('üë§ Affichage navbar invit√©');
            const navGuest = document.getElementById('nav-guest');
            const navUser = document.getElementById('nav-user');
            const navAdmin = document.getElementById('nav-admin');
            
            console.log('Elements trouv√©s:', {
                guest: navGuest ? 'OUI' : 'NON',
                user: navUser ? 'OUI' : 'NON', 
                admin: navAdmin ? 'OUI' : 'NON'
            });
            
            if (navGuest) navGuest.style.display = 'block';
            if (navUser) navUser.style.display = 'none';
            if (navAdmin) navAdmin.style.display = 'none';
        }

        function showUserNav(user) {
            console.log('üîÑ Affichage navbar pour:', user.role);
            const navGuest = document.getElementById('nav-guest');
            const navUser = document.getElementById('nav-user');
            const navAdmin = document.getElementById('nav-admin');
            const userInfo = document.getElementById('user-info');
            const adminInfo = document.getElementById('admin-info');
            
            console.log('Elements trouv√©s:', {
                guest: navGuest ? 'OUI' : 'NON',
                user: navUser ? 'OUI' : 'NON', 
                admin: navAdmin ? 'OUI' : 'NON'
            });
            
            if (navGuest) navGuest.style.display = 'none';
            
            if (user.role === 'admin') {
                if (navUser) navUser.style.display = 'none';
                if (navAdmin) navAdmin.style.display = 'block';
                if (adminInfo) adminInfo.textContent = `Admin: ${user.email}`;
                console.log('üëë Navbar admin affich√©e');
            } else {
                if (navUser) navUser.style.display = 'block';
                if (navAdmin) navAdmin.style.display = 'none';
                if (userInfo) userInfo.textContent = user.email;
                console.log('üë§ Navbar utilisateur affich√©e');
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            window.location.href = '/';
        }

        // Mettre √† jour la navbar au chargement de la page
        document.addEventListener('DOMContentLoaded', updateNavbar);
    </script>

</body>
</html>